name: Build GFS 250mb Wind Tiles

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install numpy xarray cfgrib eccodes rasterio matplotlib requests

      - name: Download latest GFS (NOAA NOMADS)
        run: |
          mkdir -p data

          NOW_UTC=$(date -u +"%H")
          DATE_UTC=$(date -u +"%Y%m%d")

          if [ "$NOW_UTC" -ge 18 ]; then
            CYCLE=12
          elif [ "$NOW_UTC" -ge 6 ]; then
            CYCLE=00
          else
            CYCLE=12
            DATE_UTC=$(date -u -d "yesterday" +"%Y%m%d")
          fi

          VALID_UTC="${DATE_UTC}${CYCLE}"
          echo "Using VALID_UTC=${VALID_UTC}"

          echo "VALID_UTC=${VALID_UTC}" >> $GITHUB_ENV

          wget -q -O data/gfs.grib2 \
            https://nomads.ncep.noaa.gov/pub/data/nccf/com/gfs/prod/gfs.${DATE_UTC}/${CYCLE}/atmos/gfs.t${CYCLE}z.pgrb2.0p25.f000

      - name: Generate COLOR 250mb wind GeoTIFF
        run: |
          python << 'EOF'
          import xarray as xr
          import numpy as np
          import rasterio
          from rasterio.transform import from_origin
          import matplotlib
          matplotlib.use("Agg")
          import matplotlib.pyplot as plt

          ds_u = xr.open_dataset(
              "data/gfs.grib2",
              engine="cfgrib",
              backend_kwargs={"filter_by_keys": {"shortName": "u"}},
          )
          ds_v = xr.open_dataset(
              "data/gfs.grib2",
              engine="cfgrib",
              backend_kwargs={"filter_by_keys": {"shortName": "v"}},
          )

          u = ds_u["u"].sel(isobaricInhPa=250)
          v = ds_v["v"].sel(isobaricInhPa=250)

          speed = np.sqrt(u**2 + v**2) * 1.94384

          speed = speed.assign_coords(
              longitude=(((speed.longitude + 180) % 360) - 180)
          ).sortby("longitude").sortby("latitude", ascending=False)

          lats = speed.latitude.values
          lons = speed.longitude.values
          dx = abs(lons[1] - lons[0])
          dy = abs(lats[1] - lats[0])

          transform = from_origin(lons.min(), lats.max(), dx, dy)

          data = np.clip(speed.values, 20, 225)
          norm = (data - 20) / (225 - 20)

          cmap = plt.get_cmap("turbo")
          rgb = (cmap(norm)[..., :3] * 255).astype("uint8")

          with rasterio.open(
              "output_250mb_color.tif",
              "w",
              driver="GTiff",
              height=rgb.shape[0],
              width=rgb.shape[1],
              count=3,
              dtype="uint8",
              crs="EPSG:4326",
              transform=transform,
          ) as dst:
              for i in range(3):
                  dst.write(rgb[:, :, i], i + 1)
          EOF

      - name: Generate map tiles (zoom 0-4)
        run: |
          rm -rf tiles/250mb/latest
          mkdir -p tiles/250mb/latest
          gdal2tiles.py --profile=mercator --xyz -r bilinear -z 0-4 \
            output_250mb_color.tif tiles/250mb/latest

          date > tiles/250mb/latest/last_update.txt

      - name: Build RAOB 250mb dataset (apples-to-apples)
        env:
          VALID_UTC: ${{ env.VALID_UTC }}
        run: |
          python scripts/build_raob_250mb_dataset.py

      - name: Commit updated tiles and RAOB data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add tiles/250mb/latest data/raob/latest.json || true
          git commit -m "Update GFS 250mb tiles + RAOB dataset ($VALID_UTC)" || echo "No changes"

          git push

name: Build GFS 250mb Wind Tiles

on:
  schedule:
    - cron: '0 */6 * * *'   # every 6 hours (UTC)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gdal-bin
          pip install numpy xarray cfgrib eccodes rasterio

      - name: Download latest GFS 0.25Â° (00z f000)
        run: |
          mkdir -p data
          ymd=$(date -u +%Y%m%d)
          base="https://nomads.ncep.noaa.gov/pub/data/nccf/com/gfs/prod"
          url="$base/gfs.$ymd/00/atmos/gfs.t00z.pgrb2.0p25.f000"
          echo "Downloading $url"
          curl -fSL "$url" -o data/gfs.grib2

      - name: Generate 250mb wind speed GeoTIFF
        run: |
          python << 'EOF'
          import xarray as xr
          import numpy as np
          import rasterio
          from rasterio.transform import from_origin

          # Open U component on isobaric levels
          ds_u = xr.open_dataset(
              "data/gfs.grib2",
              engine="cfgrib",
              backend_kwargs={
                  "filter_by_keys": {
                      "typeOfLevel": "isobaricInhPa",
                      "shortName": "u"
                  }
              },
          )

          # Open V component on isobaric levels
          ds_v = xr.open_dataset(
              "data/gfs.grib2",
              engine="cfgrib",
              backend_kwargs={
                  "filter_by_keys": {
                      "typeOfLevel": "isobaricInhPa",
                      "shortName": "v"
                  }
              },
          )

          # Select 250 mb level
          u = ds_u["u"].sel(isobaricInhPa=250)
          v = ds_v["v"].sel(isobaricInhPa=250)

          # Wind speed in m/s, then knots
          speed_ms = np.sqrt(u**2 + v**2)
          speed_kt = speed_ms * 1.94384

          # Lat/lon and grid spacing
          lats = speed_kt.latitude.values
          lons = speed_kt.longitude.values

          dy = float(abs(lats[1] - lats[0]))
          dx = float(abs(lons[1] - lons[0]))

          transform = from_origin(
              float(lons.min()),
              float(lats.max()),
              dx,
              dy
          )

          # Write GeoTIFF as float32
          with rasterio.open(
              "output_250mb.tif",
              "w",
              driver="GTiff",
              height=speed_kt.shape[0],
              width=speed_kt.shape[1],
              count=1,
              dtype="float32",
              crs="EPSG:4326",
              transform=transform,
          ) as dst:
              dst.write(speed_kt.values.astype("float32"), 1)

          print("250mb wind speed GeoTIFF written successfully")
          EOF

      - name: Convert GeoTIFF to 8-bit
        run: |
          # Create an 8-bit VRT with auto scaling
          gdal_translate -of VRT -ot Byte -scale output_250mb.tif temp_250mb.vrt

      - name: Generate map tiles (zoom 0-4)
        run: |
          rm -rf tiles/250mb/latest
          mkdir -p tiles/250mb/latest
          gdal2tiles.py -z 0-4 temp_250mb.vrt tiles/250mb/latest

      - name: Commit updated tiles
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add tiles/250mb/latest || true
          git commit -m "Update GFS 250mb tiles" || echo "No changes to commit"
          git push
